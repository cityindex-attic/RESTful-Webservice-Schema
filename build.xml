<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="4.0" DefaultTargets="Go" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <PropertyGroup>
    <Configuration Condition="'$(Configuration)' == ''">Debug</Configuration>
    <RootDirectory>$(MSBuildProjectDirectory)</RootDirectory>
    <DropDirectory>$(RootDirectory)\dist</DropDirectory>
    <DropLibDirectory>$(DropDirectory)\lib</DropLibDirectory>
    <DropContentDirectory>$(DropDirectory)\content</DropContentDirectory>
    <DropToolsDirectory>$(DropDirectory)\tools</DropToolsDirectory>

    <ProgramFiles32bit>C:\Program Files</ProgramFiles32bit>
    <ProgramFiles32bit Condition="Exists('C:\Program Files (x86)')">C:\Program Files (x86)</ProgramFiles32bit>
    <NunitEXE>$(ProgramFiles32bit)\NUnit 2.5.7\bin\net-2.0\nunit-console.exe</NunitEXE>
    <NUnitArgs>/process=Single /domain=Single /nothread /framework=4.0.30319</NUnitArgs>

    <NuGetEXE>$(RootDirectory)\tools\nuget\nuget.exe</NuGetEXE>
  </PropertyGroup>
  
<!--   <ItemGroup>-->
<!--       <RegexTransform Include="$(RootDirectory)\NuPack.Tools\source.extension.vsixmanifest">        -->
<!--           <Find>&lt;Version&gt;(?&lt;major&gt;\d+)\.(?&lt;minor&gt;\d+)\.\d+\.(?&lt;revision&gt;\d+)&lt;/Version&gt;</Find>-->
<!--           <ReplaceWith>&lt;Version&gt;$(BUILD_NUMBER)&lt;/Version&gt;</ReplaceWith>-->
<!--       </RegexTransform>-->
<!--       <RegexTransform Include="$(RootDirectory)\Common\CommonAssemblyInfo.cs">-->
<!--           <Find>(?&lt;major&gt;\d+)\.(?&lt;minor&gt;\d+)\.\d+\.(?&lt;revision&gt;\d+)</Find>-->
<!--           <ReplaceWith>$(BUILD_NUMBER)</ReplaceWith>-->
<!--       </RegexTransform>-->
<!--   </ItemGroup>-->

   <Target Name="Go" DependsOnTargets="UpdateVersion; 
                                       Build; RunTests; 
                                       CreateDropDirectories; CopyMSBuildOutputToDropDirectory; CopyLicenseToAllDirectories; 
                                       Package">
   </Target>
   
   <Target Name="UpdateVersion" Condition="'$(BUILD_NUMBER)' != ''">
<!--       <RegexTransform Items="@(RegexTransform)" />-->
   </Target>

   <Target Name="Build">
       <MSBuild Projects="$(RootDirectory)\RESTful-Webservice-Schema.sln" Targets="Rebuild" Properties="EnableCodeAnalysis=true;GenerateDocumentation=true" />
   </Target>

   <Target Name="RunTests">
     <CreateItem Include="$(RootDirectory)\src\**\bin\$(Configuration)\*.Tests.dll">
       <Output TaskParameter="Include" ItemName="TestAssemblies" />
     </CreateItem>
      <Exec ContinueOnError='true' Command='"$(NUnitEXE)" %(TestAssemblies.Identity) $(NUnitArgs) /xml:%(TestAssemblies.Identity).NUnitResults.xml'  >
         <Output TaskParameter="ExitCode" ItemName="ExitCodes"/>
      </Exec>
      <Error Text="Test error occurred" Condition="'%(ExitCodes.Identity)'>0"/>
   </Target>

   <Target Name="CreateDropDirectories">
       <Message Text="Making the output directories for the compiled output at '$(DropDirectory)'." />
       <RemoveDir Directories="$(DropDirectory)" Condition="Exists('$(DropDirectory)')" ContinueOnError="True" />
       <MakeDir Directories="$(DropDirectory)" Condition="!Exists('$(DropDirectory)')" />
       <MakeDir Directories="$(DropLibDirectory)" Condition="!Exists('$(DropLibDirectory)')" />
       <MakeDir Directories="$(DropContentDirectory)" Condition="!Exists('$(DropContentDirectory)')" />
       <MakeDir Directories="$(DropToolsDirectory)" Condition="!Exists('$(DropToolsDirectory)')" />
   </Target>

   <Target Name="CopyMSBuildOutputToDropDirectory">
     <ItemGroup>
       <MSBuildOutputItems Exclude="$(RootDirectory)\**\*.pdb" Include="$(RootDirectory)\src\MetadataProcessor\bin\$(Configuration)\*.*" />
     </ItemGroup>
     <Message Text="Copying dll output to $(DropLibDirectory)" />
     <Copy ContinueOnError="false" SourceFiles="@(MSBuildOutputItems)" DestinationFiles="@(MSBuildOutputItems ->'$(DropLibDirectory)\%(RecursiveDir)%(Filename)%(Extension)')" />
   </Target>
   
   <Target Name="CopyLicenseToAllDirectories">
       <ItemGroup>
           <LicenseFileItems Include="$(RootDirectory)\LICENSE.txt" />
       </ItemGroup>
       <Message Text="Copying the License to all drop directories" />
       <Copy ContinueOnError="false" SourceFiles="@(LicenseFileItems)" DestinationFiles="@(LicenseFileItems -&gt;'$(DropDirectory)\%(RecursiveDir)%(Filename)%(Extension)')" />
   </Target>

  <Target Name="Package">
    <ItemGroup>
      <LicenseFileItems Include="$(RootDirectory)\LICENSE.txt" />
    </ItemGroup>
    <Message Text="Packaging with NuGet" />
    <Copy SourceFiles="$(RootDirectory)\src\RESTful-Webservice-Schema.nuspec.xml" DestinationFolder="$(DropDirectory)"/>
    <Exec Command='"$(NuGetEXE)" pack $(DropDirectory)\RESTful-Webservice-Schema.nuspec.xml' ContinueOnError='false'
          WorkingDirectory='$(DropDirectory)'/>
  </Target>
</Project>